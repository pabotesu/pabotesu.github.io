<!doctype html><html lang=ja-jp>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=icon href=https://pabotesu.github.io/favicon.ico>
<link rel=stylesheet href=/css/style.min.css>
<meta property="og:site_name" content="/var/log/pabotesu">
<meta property="og:title" content="20250415 Wireguardでポート開放のような機能を実現する">
<meta property="og:type" content="website">
<meta property="og:url" content="https://pabotesu.github.io/posts/20250415-wireguard%E3%81%A7%E3%83%9D%E3%83%BC%E3%83%88%E8%A7%A3%E6%94%BE%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E6%A9%9F%E8%83%BD%E3%82%92%E5%AE%9F%E7%8F%BE%E3%81%99%E3%82%8B/">
<meta property="og:description" content="my-post-contents">
<meta name=description content="my-post-contents">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="20250415 Wireguardでポート開放のような機能を実現する">
<meta name=twitter:description content="my-post-contents">
<title>
20250415 Wireguardでポート開放のような機能を実現する - /var/log/pabotesu
</title>
<style>@import "https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css";code{font-family:fira code,monospace}</style>
<script type=module>
  import PhotoSwipeLightbox from 'https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe-lightbox.esm.min.js';
  const lightbox = new PhotoSwipeLightbox({
    gallery: '.post-content',
    children: '.pswp-child',
    pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe.esm.min.js')
  });
  lightbox.init();
</script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe.min.css>
</head>
<body>
<div id=main>
<header>
<nav>
<div class=site-logo>
<a class=no-decoration href=https://pabotesu.github.io>
/var/log/pabotesu
</a>
</div>
<div class=menu-item>
<span id=menu-button>menu</span>
</div>
</nav>
<div id=popup-menu class=hide>
<ul>
<li>
<a href=/about class=no-decoration>About</a>
</li>
<li>
<a href=/archives class=no-decoration>Archives</a>
</li>
<li>
<a href=/tags class=no-decoration>Tags</a>
</li>
</ul>
</div>
</header>
<div class=content>
<ol class=breadcrumb>
<li><a href=https://pabotesu.github.io/>Home</a>
<li><a href=https://pabotesu.github.io/posts/>Posts</a>
<li>20250415 Wireguardでポート開放のような機能を実現する
</ol>
</ol>
<span class=post-title data-pagefind-body>20250415 Wireguardでポート開放のような機能を実現する</span>
<div class=post-meta>
<span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
<time>2025-04-15 23:31:20</time>
</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg>
<a href=https://github.com/pabotesu/pabotesu.github.io/tree/main/content/posts/20250415-wireguard%e3%81%a7%e3%83%9d%e3%83%bc%e3%83%88%e8%a7%a3%e6%94%be%e3%81%ae%e3%82%88%e3%81%86%e3%81%aa%e6%a9%9f%e8%83%bd%e3%82%92%e5%ae%9f%e7%8f%be%e3%81%99%e3%82%8b.md target=_blank rel="noopener noreferrer">History</a>
</span>
<div>
<span>
<a href=https://pabotesu.github.io/tags/wireguard/>#wireguard</a>
</span>
<span>
<a href=https://pabotesu.github.io/tags/network/>#network</a>
</span>
</div>
</div>
<div class=toc>
<details>
<summary>Toc</summary>
<nav id=TableOfContents>
<ul>
<li><a href=#注意点>注意点</a></li>
<li><a href=#はじまり>はじまり</a></li>
<li><a href=#実現可能なサービスについて>実現可能なサービスについて</a></li>
<li><a href=#実装例>実装例</a>
<ul>
<li><a href=#解説>解説</a></li>
</ul>
</li>
<li><a href=#詳細>詳細</a>
<ul>
<li><a href=#vps側の設定例>vps側の設定例</a></li>
<li><a href=#クライアントwebサーバ側の設定>クライアント（webサーバ側）の設定</a></li>
<li><a href=#アクセステスト>アクセステスト</a></li>
</ul>
</li>
<li><a href=#展望>展望</a></li>
<li><a href=#参考>参考</a></li>
</ul>
</nav>
</details>
</div>
<article class=post-content data-pagefind-body>
<h1 id=wireguardでポート開放のような機能を実現する>Wireguardでポート開放のような機能を実現する&nbsp;<a class=headline-hash href=#wireguardでポート開放のような機能を実現する>#</a> </h1>
<h2 id=注意点>注意点&nbsp;<a class=headline-hash href=#注意点>#</a> </h2>
<p>本稿で実装した機能については限定的な用途に絞っており、<br>
読者の皆様のネットワーク環境における安全性を確実に担保する保障はございません。<br>
試用される際は自己責任でお願いします。<br>
あと、普通に悪用厳禁です。</p>
<h2 id=はじまり>はじまり&nbsp;<a class=headline-hash href=#はじまり>#</a> </h2>
<p>私事ではありますが、引越しを経て大きくネットワーク環境を変更するに至りました。<br>
詳しい言及は本稿では避けますが、一般的なIPv6環境(MAP-Eによる広告)と相成りました。<br>
お察しの通り、この状態だとポート開放はいささか難しいものがございます。<br>
特に最近の傾向ですと己がサービスをISPの網を通して公開するというのは避けがちとの所感を得ております。<br>
そこで、<a href=https://www.wireguard.com/ target=_blank rel="noopener noreferrer">wiregurad</a>
を利用して擬似ポート開放のような物を実現できないかと思慮した次第でございます。</p>
<h2 id=実現可能なサービスについて>実現可能なサービスについて&nbsp;<a class=headline-hash href=#実現可能なサービスについて>#</a> </h2>
<p>当方の思慮している環境を構築できる既存サービスはいくつかあります。</p>
<ul>
<li><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/ target=_blank rel="noopener noreferrer">Cloudflare Tunnel</a>
</li>
<li><a href=https://ngrok.com/ target=_blank rel="noopener noreferrer">ngrock</a>
</li>
<li><a href=https://tailscale.com/ target=_blank rel="noopener noreferrer">Tailscale</a>
</li>
<li>etc &mldr;</li>
</ul>
<p>今を馳せるクラウドネットワークリソースサービスの皆様ですね</p>
<h2 id=実装例>実装例&nbsp;<a class=headline-hash href=#実装例>#</a> </h2>
<p>
<img src=/img/20250416-wireguard-openport/wireguard_open_ports.png alt=wireguard_open_ports.png>
</p>
<h3 id=解説>解説&nbsp;<a class=headline-hash href=#解説>#</a> </h3>
<ol>
<li>user01はvpsに付与されているglobalIPアドレス宛に8080ポートにアクセス</li>
<li>vpsで動作するwireguardは事前に設定されているポートとIPアドレス宛にポート転送を行う</li>
<li>自宅で動作しているwebサーバはwireguardの網を通してHTMLコンテンツをuser01に表示する</li>
</ol>
<p>ザックリ上記の動作を実装しました</p>
<h2 id=詳細>詳細&nbsp;<a class=headline-hash href=#詳細>#</a> </h2>
<h3 id=vps側の設定例>vps側の設定例&nbsp;<a class=headline-hash href=#vps側の設定例>#</a> </h3>
<p>vps側のIP状態</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>root@vultr:~# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 56:00:05:40:cc:a0 brd ff:ff:ff:ff:ff:ff
    inet 198.xxx.xxx.xxx/23 metric 100 brd 198.13.53.255 scope global dynamic enp1s0
       valid_lft 85682sec preferred_lft 85682sec
    &lt;snip&gt;
6: wg80: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000
    link/none
    inet 10.0.0.1/24 scope global wg80
       valid_lft forever preferred_lft forever
</code></pre></div><p>vps側のwiregusard設定</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>root@vultr:~# cat /etc/wireguard/wg80.conf
[Interface]
# サーバーのプライベートキー
PrivateKey = &lt;snip&gt;
# サーバーのVPN内IPアドレス
Address = 10.0.0.1/24
# サーバーがリッスンするポート
ListenPort = 51820

# トンネル接続時に実行するコマンド（例：NATルールの追加）
PostUp = nft add table ip nat; nft add chain ip nat prerouting { type nat hook prerouting priority 0 \; }; nft add chain ip nat postrouting { type nat hook postrouting priority 100 \; }; nft add rule ip nat prerouting tcp dport 8080 dnat to 10.0.0.2:8080; nft add rule ip nat postrouting oif enp1s0 masquerade

# トンネル切断時に実行するコマンド（例：NATルールの削除）
PostDown = nft delete table ip nat

[Peer]
# クライアントの公開鍵
PublicKey = snip
# クライアントのVPN内IPアドレス
AllowedIPs = 10.0.0.2/32

root@vultr:~#
</code></pre></div><p>上記の設定で外部から受けた8080の通信に限り、peerに転送するようにしてます。</p>
<h3 id=クライアントwebサーバ側の設定>クライアント（webサーバ側）の設定&nbsp;<a class=headline-hash href=#クライアントwebサーバ側の設定>#</a> </h3>
<p>クライアント（webサーバ側）のIP状態</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>root@pabotesu-raspi:/home/pabotesu# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether e4:5f:01:10:d0:ad brd ff:ff:ff:ff:ff:ff
    inet 192.168.100.57/24 brd 192.168.100.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
    &lt;snip&gt;
3: wlan0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether e4:5f:01:10:d0:ae brd ff:ff:ff:ff:ff:ff
5: wg80: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000
    link/none
    inet 10.0.0.2/2 scope global wg80
       valid_lft forever preferred_lft forever
root@pabotesu-raspi:/home/pabotesu#
</code></pre></div><p>snipしてますが、ここでIPv6が振られてます。<br>
通常インターネットに出る際はIPv6を利用し、IPv4サイトへはトンネルングされてアクセスします。</p>
<p>クライアント（webサーバ側）のwireguardの設定</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>root@pabotesu-raspi:/home/pabotesu# cat /etc/wireguard/wg80.conf
[Interface]
#client privatekey
PrivateKey = &lt;snip&gt;
Address = 10.0.0.2/2

[Peer]
#server publickey
PublicKey = &lt;snip&gt;
Endpoint = 198.xxx.xxx.xxx:51820
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = 25
root@pabotesu-raspi:/home/pabotesu#
</code></pre></div><p>普通にvpsに接続されます。<br>
<code>PersistentKeepalive</code>の設定を入れることにより、接続性を維持できます。<br>
外から受ける8080のアクセスはあくまで、wireguardの通信外での動きなので、このようにセッションを維持する設定が必要です。</p>
<p>あとは適当にwebサーバで8080を受けるようにしてやれば、準備完了</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>root@pabotesu-raspi:/home/pabotesu# cat /etc/nginx/sites-available/default
&lt;snip&gt;
#
server {
        listen 8080 default_server;
        listen [::]:8080 default_server;
</code></pre></div><h3 id=アクセステスト>アクセステスト&nbsp;<a class=headline-hash href=#アクセステスト>#</a> </h3>
<p>以下のようにvpsのglobalIPに8080でアクセスすれば自宅のwebサーバで回しているコンテンにアクセスできました。</p>
<p>
<img src=/img/20250416-wireguard-openport/wireguad_webpage.png alt=wireguad_webpage.png>
</p>
<p>以上となります。</p>
<h2 id=展望>展望&nbsp;<a class=headline-hash href=#展望>#</a> </h2>
<ul>
<li>近いうちにglobalIPを持っているサーバ側の設定を簡易的にできるツールを作ります。</li>
<li>次のモチベーション的にクライアント間通信を実現して、tailscaleっぽい通信動作を作ってみようと思います。
<ul>
<li>この場合特定通信に絞って疎通させるので、クライアント側にルーティング設定が必要そうです。</li>
</ul>
</li>
<li>更に先には現在nftablesで実装している部分をnetlinkで実装して、いろんなディストロで使えるようにしてみたり、ネットワークの低レイヤを理解できるようにします。</li>
</ul>
<h2 id=参考>参考&nbsp;<a class=headline-hash href=#参考>#</a> </h2>
<ul>
<li><a href=https://www.wireguard.com/#conceptual-overview target=_blank rel="noopener noreferrer">https://www.wireguard.com/#conceptual-overview</a>
</li>
<li><a href=https://www.wireguard.com/#cryptokey-routing target=_blank rel="noopener noreferrer">https://www.wireguard.com/#cryptokey-routing</a>
</li>
<li><a href=https://manual.iij.jp/iot/doc/47981302.html target=_blank rel="noopener noreferrer">https://manual.iij.jp/iot/doc/47981302.html</a>
</li>
</ul>
</article>
<div class=post-nav>
<span class=post-nav-next>
<a href=https://pabotesu.github.io/posts/20250614-wireguard%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9Fnattraversal%E3%81%AAp2p%E9%80%9A%E4%BF%A1%E3%81%AE%E5%AE%9F%E8%A3%85/><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
<br>
20250614 Wireguardを利用したNATtraversalなP2P通信の実装
</a>
</span>
<span class=post-nav-prev>
<a href=https://pabotesu.github.io/posts/20240120-my-nixos-env/><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
<br>
20240120 My NixOS Env
</a>
</span>
</div>
<script src=https://utteranc.es/client.js repo=pabotesu/pabotesu.github.io issue-term=pathname theme=preferred-color-scheme crossorigin=anonymous async></script>
</div>
<footer>
<div class=footer-text>&copy; 2023 pabotesu Powered by <a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a></div>
</footer>
</div>
<script src=/js/script.min.js></script>
</body>
</html>